---
title: "Dropped_Stats"
output: html_document
date: "2023-01-27"
desc: This file is created for analysis of dropped frames versus vEMG for EMBC2023
# theme: darkly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r including libraries}
library(magrittr); library(here); library(janitor)
library(readxl); library(tidyverse)
library(rmdformats)
library(Epi)
library(vcd)
library(broom)
library(patchwork)
library(vcd)
library(dplyr)
library(ggplot2)
```


```{r Data Inject } 

dt <- read_csv("dropped_stats.csv",show_col_types = FALSE)
summary(dt)
dt

dt<-dt%>%mutate(Filt_Type = as.factor(Filt_Type),
                   Repeat = as.factor(Repeat),
                     Feat = as.factor(Feat),
                     Test = as.factor(Test),
                     MVC_Voli = as.factor(MVC_Voli),
                     MVC_Stim = as.factor(MVC_Stim),
                     Frame = as.integer(Frame),
                     Dropped = as.integer(Dropped))
```
# Mean percent difference of filters based on norm. values:

$\sum_{i=1}^{I=10} \frac{1}{I}\frac{MAV_{D,i}-MAV_{F,i}}{MAV_{D,i}}\times100$

```{r}


rmse <- function(x, reference) {
  sqrt(mean((x - reference)^2))
}

percent_diff <- function( mav_f, reference) {
  i_max <- length(mav_f)
  sum((mav_d - mav_f) / mav_d) * 100 / i_max
}

dt_means <- aggregate(dt$Norm_Val, by = list(Trial = dt$Trial, Test = dt$Test, Filt_Type = dt$Filt_Type, Repeat = dt$Repeat, MVC_Voli = dt$MVC_Voli, MVC_Stim = dt$MVC_Stim,Dropped = dt$Dropped), mean)
dt_means <- dt_means %>% rename(Filt_Mean_Val = x)

ref_dt <-dt_means %>% filter(Filt_Type=='Dropped')

agg_results <- aggregate(dt$Filt_Mean_Val, by = list(Trial = dt$Trial, Test = dt$Test, Filt_Type = dt$Filt_Type, Repeat = dt$Repeat, MVC_Voli = dt$MVC_Voli, MVC_Stim = dt$MVC_Stim,Dropped = dt$Dropped), mean)
```

```{r}

rmse <- function(x, reference) {
  sqrt(mean((x - reference)^2))
}

percent_diff <- function( mav_f, mav_d) {
mav_f/mav_d
}


ref_dt <-dt_means %>% filter(Filt_Type=='Dropped')

agg_results <- dt_means%>% mutate(rms= percent_diff(dt_means$Filt_Mean_Val, ref_dt$Filt_Mean_Val))

```
This table is created using MATLAB making sure that there is no NAN, missing or infinite sample of any variable


```{r Quick Look}

 ggplot(dt, aes(x = "", y = Norm_Val)) + geom_violin() + geom_boxplot(width = 0.4) + coord_flip() + labs(x = "")

```

The distribution is not perfectly normal, but it should be ok to use "ANOVA".

```{r plotting using facets}

plot<-filter(dt, Filt_Type !='Unfilt' )%>% select( c(Frame_Val,Norm_Val, Target, Filt_Type, Dropped,Frame,Test,MVC_Voli,MVC_Stim) )  

drop_1<- filter(plot, Dropped=='1')
model_1 <- lm(Norm_Val ~ Filt_Type, data = drop_1) 
drop_2<- filter(plot, Dropped=='2')
model_2 <- lm(Norm_Val ~ Filt_Type, data = drop_2) 
drop_3<- filter(plot, Dropped=='3')
model_3 <- lm(Norm_Val ~ Filt_Type, data = drop_3) 
drop_4<- filter(plot, Dropped=='4')
model_4 <- lm(Norm_Val ~ Filt_Type, data = drop_4) 
drop_5<- filter(plot, Dropped=='5')
model_5 <- lm(Norm_Val ~ Filt_Type, data = drop_5) 
drop_6<- filter(plot, Dropped=='6')
model_6 <- lm(Norm_Val ~ Filt_Type, data = drop_6) 
drop_7<- filter(plot, Dropped=='7')
model_7 <- lm(Norm_Val ~ Filt_Type, data = drop_7) 
drop_8<- filter(plot, Dropped=='8')
model_8 <- lm(Norm_Val ~ Filt_Type, data = drop_8) 
drop_9<- filter(plot, Dropped=='9')
model_9 <- lm(Norm_Val ~ Filt_Type, data = drop_9) 
drop_10<- filter(plot, Dropped=='10')
model_10 <- lm(Norm_Val ~ Filt_Type, data = drop_10) 

mosaic::favstats( Norm_Val~ Filt_Type, MVC_Voli, data = plot)%>% knitr::kable(digits = 2)

ggplot(data = plot, aes(x = Frame, y = Norm_Val, color = Filt_Type)) + 
geom_point(size = 1, alpha = 0.6) +
geom_smooth(method = "loess", se = FALSE, size = 1.5) +facet_wrap(~ MVC_Voli )+
labs(title = "Normalized EMG MAV Values", y = "Norm. MAV")
   
```


```{r Normality Checks of Groups 1- by violing plots}
MVCVoli10<- filter(plot, MVC_Voli=='10%')
test_jan7<- filter(plot,MVC_Voli=='10%',Dropped=='1')

ggplot(test_jan7, aes(x = Filt_Type, y = Norm_Val, fill = Filt_Type)) + geom_violin() +
scale_fill_viridis_d() + geom_boxplot(width = 0.3, fill = "white") +
guides(fill = FALSE) +
labs(title = "Box and Violing Plots of the Filtered, Unfiltered and Dropped MAV Values (Normalized)",
x = "", y = "Normalized MAV ") + coord_flip() +
theme_bw()

```

These subgroups are not perfectly normal either.

```{r Nomality Checks 2-Histogram}

ggplot(test_jan7, aes(x = Norm_Val, fill = Filt_Type, color = Filt_Type)) + geom_histogram(bins = 50) +
scale_fill_viridis_d() +
scale_color_viridis_d(direction = -1) +
guides(fill = FALSE, color = FALSE) +
labs(title = "Histograms of Filtered, Unfiltered and Dropped MAV Values (Normalized)",
x = "Normalized MAV") + theme_bw() +
facet_wrap(~ Filt_Type)

```

```{r Normality Checks 3-QQ Plots}

ggplot(test_jan7, aes(sample = Norm_Val)) + geom_qq() + geom_qq_line(col = "red") + theme_bw() +
facet_wrap(~ Filt_Type) +
labs(y = " Normalized MAV Values")

```

Q-Q Plots also show some imperfections.



```{r}

```
# Can we detect the differences in mean using a linear fitting model?
```{r }

filt_variables<- filter(test_jan7, Filt_Type==c('Dropped', 'Comb' ,'GS'))
model_one <- lm(Norm_Val ~ Filt_Type, data = filt_variables) 

tidy(model_one, conf.int = 0.90) %>% select(term, estimate, std.error,
conf.low, conf.high, p.value) %>% kable(dig = 2)

glance(model_one) %>% select(r.squared) %>% kable(digits = 3)

```

All filter types are significant with r-squared being 0.004

```{r}

DropNum<-drop_1 %>%filter( Filt_Type =='Dropped' )%>%group_by(Dropped) %>% summarise(count = n(), mean(Norm_Val), median(Norm_Val))
DropNum

```

```{r Anova Model}

tidy(anova(model_one)) %>% kable(dig = 3)


```

```{r f statistic }
pf(2481, df1 = 2, df2 = 7557, lower.tail = FALSE)
```

```{r balanced design }

oneway.test(Norm_Val ~ Filt_Type, data = filt_variables)

```

```{r Kruskal Wallis}

kruskal.test(Norm_Val ~ Filt_Type, data = filt_variables)

```


```{r Quick look at the numerical summaries}

 mosaic::favstats( Norm_Val~ Filt_Type, data = filt_variables)%>% knitr::kable(digits = 2)

```

1- Looks like we are dealing with the an unbalanced design with Dropped category (n=1080) having 1/10 of the others.
2- We can also make equal variances for the filter groups (Dropped, Comb and GS).

```{r Multicompare: Bonferroni a:0.05}
pairwise.t.test(filt_variables$Norm_Val, filt_variables$Filt_Type, p.adjust.method = "bonferroni")
```

```{r Tukey HSD}

tukey_one <- tidy(TukeyHSD(aov(model_one), ordered = TRUE, conf.level = 0.9))
tukey_one %>% rename(null = null.value) %>% kable(dig = 3)
TukeyHSD(aov(Norm_Val ~ Filt_Type, data = filt_variables), conf.level = 0.90)

```


```{r}
ggplot(tukey_one, aes(x = reorder(contrast, -estimate), y = estimate)) +
geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) + geom_hline(yintercept = 0, col = "red",
linetype = "dashed") + geom_label(aes(label = round_half_up(estimate,2))) + coord_flip() +
labs(x = "Contrast between Education Groups",
   y = "Estimated Effect",
   title = "Estimated Effects, with Tukey HSD 90% Confidence",
   subtitle = "Comparing Trump16 Voteby Education Group")
```



```{r }
wilx<-filter(test_jan7, Filt_Type==c('Dropped' ,'GS'))

w1 <- tidy(wilcox.test(Norm_Val ~ Filt_Type, data = wilx, conf.int = TRUE, conf.level = 0.90))
w1
```


```{r }
boot4 <- dm431_cc %$% bootdif(ldl, statin, conf.level = 0.90)
boot4    
```
