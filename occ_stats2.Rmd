---
title: "Occlusion Stats v2"
output: html_document
date: "2023-04-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r including libraries, display=FALSE}
library(magrittr); 
library(here); 
library(janitor)
library(readxl);
library(tidyverse)
library(rmdformats)
library(Epi)
library(vcd)
library(broom)
library(patchwork)
library(vcd)
library(dplyr)
library(ggplot2)
```


```{r Data Inject } 

occraw<- read_csv("occlusion_v4.csv",show_col_types = FALSE)
occdropped<- read_csv("dropped_occ.csv",show_col_types = FALSE)
occdropped
occraw

```

```{r dataframe modifications}

occ<-occraw%>%mutate(Test = as.factor(Test),

                     Tau = as.factor(Tau),
                     Feat = as.factor(Feat),
                     Filt = as.factor(Filt))

occ<-occ%>%mutate(MVC_Voli_Cat=recode(MVC_Voli,
                                '10' = 'Voli_10',
                                '20' = 'Voli_20',
                                '30' = 'Voli_30',
                                '40' = 'Voli_40')) %>%
            mutate(MVC_Stim_Cat=recode(MVC_Stim,
                                 '0' = 'Stim_0',
                                '10' = 'Stim_10',
                                '20' = 'Stim_20',
                                '30' = 'Stim_30'))

occ<-occ%>%filter(Test!="mar7",Test!="mar16",Test!="feb27")


occdropped<-occdropped%>%mutate(Test = as.factor(Test),
                     StimMVC = as.factor(StimMVC),
                     Repeat = as.factor(Repeat),
                     NumofDropped = as.factor(NumofDropped))
summary(occdropped)
occ
```


```{r Plotting: maintain section  }

plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat!='Amp_Modul')


ggplot(plot_tibble, aes(x =  v_mvc , y = vprime_mvc , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 10, y = 10, xend = 40, yend = 40, color='No Occlusion Level'))+
    facet_wrap(~Feat,scales='free')+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Maintained Volitional effort: F_vprime (% MVC)",
    title = "Maintained force and MAV for different effort levels",
    subtitle = "4 healthy participants")

lm_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat=='Force')

 m1 <- lm(vprime_mvc ~ MVC_Voli + MVC_Stim, data = lm_tibble) 
tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)



```
```{r Plotting the results }

plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat!='Amp_Modul')

ggplot(plot_tibble, aes(x =  v_mvc , y = Occ_mvc , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+
    facet_wrap(~Feat,scales='free')+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Occlusion (% MVC)",
    title = "Occluded force and MAV",
    subtitle = "4 healthy participants")

lm_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat=='Force')

 m1 <- lm(sprime_mvc ~ MVC_Voli + MVC_Stim, data = lm_tibble) 
tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)



```

```{r Plotting the results }

plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat=='Force')

ggplot(plot_tibble, aes(x =  v_mvc , y = sprime_mvc , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+
    facet_wrap(~Feat,scales='free')+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Occlusion (% MVC)",
    title = "Occluded force and MAV",
    subtitle = "4 healthy participants")

lm_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat=='Force')

 m1 <- lm(sprime_mvc ~ MVC_Voli + MVC_Stim, data = lm_tibble) 
tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

```


```{r Plotting: dropped frames occlusion}
plotibble<-filter(occdropped, NumofDropped =='1_Drops')

ggplot(plotibble, aes(x =  VoliMVC , y = Dropped_MAV , color = StimMVC)) +
    geom_point() +
    geom_smooth(method = "lm",level=0.90)+
    geom_segment(aes(x = 10, y = .31, xend = 40, yend = 1, color='No Occlusion Level'))

ggplot(plotibble, aes(x =  VoliMVC , y = Occ_MAV , color = StimMVC)) +
    geom_point() +
    geom_smooth(method = "lm")

```






```{r Occlusion Heat Map}
plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt')

ggplot(plot_tibble, aes(x = MVC_Stim_Cat , y =  MVC_Voli_Cat, fill = Occ_mvc)) +
    geom_tile() +
    geom_smooth(method = "lm")+
    facet_wrap(~Feat)

```


```{r}

plot_tibble<-filter(occ,MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt')

ggplot(plot_tibble, aes(x =  v_mvc, y = Occ_mvc, color = MVC_Stim_Cat))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_wrap(Feat~Test,scales = "free")


```

```{r Occlusion Heat Map}

plot_tibble<-filter(occ,MVC_Stim!="Stim_0",Tau=="3*tau")

ggplot(plot_tibble, aes(x =  MVC_Voli, y = MVC_Stim, fill = F_occ)) +
  geom_tile() +
  facet_wrap(~Test)

```

```{r  averaging the occlusion }

mn<-aggregate(cbind(F_occ,F_occ_mvc,F_vprime,F_vprime_mvc) ~ Test + MVC_Stim + MVC_Voli , data = filter(occ,Tau==selected_tau), FUN = mean, na.rm = TRUE)

sdt<-aggregate(cbind(F_occ,F_occ_mvc,F_vprime,F_vprime_mvc) ~ Test + MVC_Stim + MVC_Voli, data = filter(occ,Tau==selected_tau), FUN = sd, na.rm = TRUE)


occ_mean <- aggregate(data=occ, cbind(F_occ,F_occ_mvc), by = list(Test = occ$Test, 
                                             MVC_Stim = occ$MVC_Stim, 
                                             MVC_Voli = occ$MVC_Voli, 
                                             Tau = occ$Tau), mean)
occ_mean <- occ_mean %>% rename(F_occ_mean = x)

occ_sd <- aggregate(occ$F_occ, by = list(Test = occ$Test, 
                                             MVC_Stim = occ$MVC_Stim, 
                                             MVC_Voli = occ$MVC_Voli, 
                                             Tau = occ$Tau), sd)
occ_mean$f_occ_sd<-occ_sd$x

occ_mean_mvc <- aggregate(occ$F_occ_mvc, by = list(Test = occ$Test, 
                                             MVC_Stim = occ$MVC_Stim, 
                                             MVC_Voli = occ$MVC_Voli, 
                                             Tau = occ$Tau), mean)

occ_mean_mvc <- occ_mean_mvc %>% rename(F_occ_mvc_mean = x)

occ_sd_mvc <- aggregate(occ$F_occ_mvc, by = list(Test = occ$Test, 
                                             MVC_Stim = occ$MVC_Stim, 
                                             MVC_Voli = occ$MVC_Voli, 
                                             Tau = occ$Tau), sd)

occ_mean_mvc$F_occ_mvc_sd<-occ_sd_mvc$x

occ_mean$F_occ_mvc_mean<-occ_mean_mvc$F_occ_mvc_mean
occ_mean$F_occ_mvc_sd<-occ_mean_mvc$F_occ_mvc_sd

mean_occ_tbl <- occ_mean %>% group_by( MVC_Voli, MVC_Stim) %>% summarise(mean_occ_mvc=round(mean(F_occ_mvc_mean),2), Std=round(sd(F_occ_mvc_mean),2), mean_F_vprime_mvc=round(mean(F_occ_mvc_mean),2), Std=round(sd(F_occ_mvc_mean),2), n = n())

mean_occ_tbl

```

```{r }
df%>% mutate(bmi_cat = fct_reorder(bmi_cat, triceps_skinfold,.fun = median)) 

df %>% group_by(Test) %>% summarise("Pearson r" = round(cor(TimeConst, MVC_Percent, use="complete"),2), "Spearman r" = round(cor(TimeConst, MVC_Percent, method="spearman",use="complete"),2), "Mean"= round(mean(TimeConst),2))

```

```{r }
plot<-filter(dt)%>% select( c(Frame_Val,Norm_Val, Target, Filt_Type, Dropped,Frame,Test,MVC_Voli,MVC_Stim) )  

mosaic::favstats( Norm_Val~ Filt_Type, MVC_Voli, data = plot)%>% knitr::kable(digits = 2)

ggplot(data = plot, aes(x = Dropped , y = Norm_Val, color = Filt_Type)) + 
geom_boxplot() +
  scale_fill_viridis_d() +
  facet_wrap(Test~ MVC_Voli )+
labs(title = "Normalized EMG MAV Values", y = "Norm. MAV")
   
```







