---
title: "Occlusion Stats v2"
output: html_document
date: "2023-04-10"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r including libraries, display=FALSE}
library(magrittr)
library(here)
library(janitor)
library(readxl)
library(tidyverse)
library(rmdformats)
library(Epi)
library(vcd)
library(broom)
library(patchwork)
library(vcd)
library(dplyr)
library(ggplot2)
library(ggpmisc)
library(tidyr)
library(ggsignif)
library(ggpubr)
library(egg)
options(dplyr.summarise.inform = FALSE)

```

```{r Data Inject }

coefraw<- read_csv("occ_coef2.csv",show_col_types = FALSE)
droppedocc<- read_csv("dropped_occ5.csv",show_col_types = FALSE)

occraw<- read_csv("occlusion_v10.csv",show_col_types = FALSE)
err_raw<- read_csv("occ_est_error7.csv",show_col_types = FALSE)
rmse_raw<- read_csv("rmse3.csv",show_col_types = FALSE)

trial_stats_raw<- read_csv("trial_stats.csv",show_col_types = FALSE)
```

```{r dataframe modifications}

occ<-occraw%>%mutate(Test = as.factor(Test),
                     Tau = as.factor(Tau),
                     Feat = as.factor(Feat),
                     Filt = as.factor(Filt))

occ<-occ%>%mutate(EffortType = as.factor(EffortType))


occ<-occ%>%mutate(MVC_Voli_Cat=recode(MVC_Voli,
                                '10' = 'Voli_10',
                                '20' = 'Voli_20',
                                '30' = 'Voli_30',
                                '40' = 'Voli_40',
                                '50' = 'Voli_50')) %>%
            mutate(MVC_Stim_Cat=recode(MVC_Stim,
                                 '0' = 'Stim_0',
                                '10' = 'Stim_10',
                                '20' = 'Stim_20',
                                '30' = 'Stim_30',
                                '40' = 'Stim_40'))

occ<-occ%>%filter(Test!="mar7",Test!="mar16",Test!="feb27",Test!="apr20")


droppedocc<-droppedocc%>%mutate(Test = as.factor(Test),
                     Repeat = as.factor(Repeat),
                     NumofDropped = as.factor(NumofDropped))

droppedocc<-droppedocc%>%mutate(MVC_Voli_Cat=recode(MVC_Voli,
                                '10' = 'Voli_10',
                                '20' = 'Voli_20',
                                '30' = 'Voli_30',
                                '40' = 'Voli_40',
                                '50' = 'Voli_50')) %>%
            mutate(MVC_Stim_Cat=recode(MVC_Stim,
                                 '0' = 'Stim_0',
                                '10' = 'Stim_10',
                                '20' = 'Stim_20',
                                '30' = 'Stim_30',
                                '40' = 'Stim_40'))

err<-err_raw%>%mutate(MVC_Voli_Cat=recode(VoliMVC,
                                '10' = 'Voli_10',
                                '20' = 'Voli_20',
                                '30' = 'Voli_30',
                                '40' = 'Voli_40',
                                '50' = 'Voli_50')) %>%
            mutate(MVC_Stim_Cat=recode(StimMVC,
                                 '0' = 'Stim_0',
                                '10' = 'Stim_10',
                                '20' = 'Stim_20',
                                '30' = 'Stim_30',
                                '40' = 'Stim_40'))

err<-err%>%mutate(Test = as.factor(Test),
                     Filt = as.factor(Filt),
                     Occ_Type = as.factor(Occ_Type),
                     MVC_Stim_Cat = as.factor(MVC_Stim_Cat),
                     MVC_Voli_Cat = as.factor(MVC_Voli_Cat),
                     MVC_Stim = as.integer(StimMVC),
                     MVC_Voli = as.integer(VoliMVC))

err<-err%>%mutate(EffortType = as.factor(EffortType))


err<-err%>%filter(Test!="mar7",Test!="mar16",Test!="feb27",Test!="apr20")

coef<-coefraw%>%mutate(Test = as.factor(Test),
                       Type = as.factor(Type),
                       Trial = as.integer(Trial))

coef<-coef%>%mutate(MVC_Voli_Cat=recode(MVC_Voli,
                                '10' = 'Voli_10',
                                '20' = 'Voli_20',
                                '30' = 'Voli_30',
                                '40' = 'Voli_40')) %>%
            mutate(MVC_Stim_Cat=recode(MVC_Stim,
                                 '0' = 'Stim_0',
                                '10' = 'Stim_10',
                                '20' = 'Stim_20',
                                '30' = 'Stim_30'))

coef<-coef%>%filter(Test!="mar7",Test!="mar16",Test!="feb27",Test!="apr20")


rmse<-rmse_raw%>%mutate(Test = as.factor(Test),
                       Effort_Type = as.factor(Effort_Type),
                       Filt = as.factor(Filt),
                       Test = as.factor(Test),
                       Ref_Trial = as.integer(Ref_Trial))

rmse<-rmse%>%mutate(MVC_Voli_Cat=recode(MVC_Voli,
                                '10' = 'Voli_10',
                                '20' = 'Voli_20',
                                '30' = 'Voli_30',
                                '40' = 'Voli_40',
                                '50' = 'Voli_50')) %>%
            mutate(MVC_Stim_Cat=recode(MVC_Stim,
                                 '0' = 'Stim_0',
                                '10' = 'Stim_10',
                                '20' = 'Stim_20',
                                '30' = 'Stim_30',
                                '40' = 'Stim_40',
                                '50' = 'Stim_50',
                                '60' = 'Stim_60',
                                '70' = 'Stim_70',
                                '80' = 'Stim_80'))

trial_stats<-trial_stats_raw%>%mutate(Test = as.factor(Test),
                       Exp = as.factor(Exp),
                       Filt = as.factor(Filt),
                       Test = as.factor(Test))

summary(rmse$Test)
```

```{r Bar Plots Plotting rmse}

plot_rmse<-filter(rmse, Error_Type=="RMSE", Error!=0, Norm==TRUE) %>% filter(!(MVC_Stim==0 & Filt!="Unfilt"))%>%
  mutate(Filt = if_else(MVC_Stim == 0, "Ref", Filt))

plot_rmse$Filt <- factor(plot_rmse$Filt, levels = c("Ref", "GS", "Comb", "Unfilt"))

plot_rmse_summary <- plot_rmse %>%
  group_by(Filt, Effort_Type, MVC_Voli_Cat) %>%
  summarise(
    mean_error = mean(Error),
    sd_error = sd(Error),
    n = n(),  # Get the sample size
    conf_int = qt(0.975, df = n - 1) * (sd_error / sqrt(n))
  )

plot_rmse_summary_test <- plot_rmse %>%
  group_by(Filt, Effort_Type, MVC_Voli_Cat, MVC_Stim_Cat, Test) %>%
  summarise(
    mean_error = mean(Error),
    sd_error = sd(Error),
    n = n(),  # Get the sample size
    conf_int = qt(0.975, df = n - 1) * (sd_error / sqrt(n))
  )

f_tibble<-filter(plot_rmse_summary, Effort_Type == "Force")
parti_tibble<-filter(plot_rmse, Effort_Type == "Force")

g1<-ggplot(f_tibble, aes(x = Filt  , y = mean_error, fill = MVC_Voli_Cat)) +
    geom_col(position = "dodge") +
    geom_errorbar(aes(ymin = (mean_error - conf_int), ymax = (mean_error + conf_int)),
                position = position_dodge(0.9), width = 0.25) +   
  #facet_wrap(~Effort_Type)+ 
  #coord_cartesian(ylim=c(0,0.5)) + 
    labs(x = "Filter ",
    y = "Norm. Roort Mean Squared Error",
    title = "Isometric Force Experiments",
    subtitle = sprintf("%d participants",length(unique(parti_tibble$Test) )))+
  theme_minimal() +
  theme(
    strip.background = element_blank(),
    #strip.text = element_text(face = "bold"),
    legend.position = c(0.23, 0.48),  # Position legend inside the plot (top-right corner)
    legend.background = element_rect(fill = alpha("white", 0.6))  # Semi-transparent background for readability
    ) + 
    stat_compare_means(data = h_tibble,  # Use raw data for comparisons
comparisons = list(c("Ref", "GS"), c("Ref", "Comb"), c("Ref", "Unfilt")))

h_tibble<-filter(plot_rmse_summary, Effort_Type == "Hand")
parti_tibble<-filter(plot_rmse, Effort_Type == "Hand")
g2<-ggplot(h_tibble, aes(x = Filt  , y = mean_error, fill = MVC_Voli_Cat)) +
    geom_col(position = "dodge") +
    geom_errorbar(aes(ymin = (mean_error - conf_int), ymax = (mean_error + conf_int)),
                position = position_dodge(0.9), width = 0.25) +    
  facet_wrap(~Effort_Type)+ 
  #coord_cartesian(ylim=c(0,0.5)) + 
    labs(x = "Filter ",
    y = "Norm. Roort Mean Squared Error",
    title = "Finger Extension Experiments",
    subtitle = sprintf("%d participants",length(unique(parti_tibble$Test) )))+
  theme_minimal() +
  theme(
    strip.background = element_blank(),
    #strip.text = element_text(face = "bold"),
    legend.position = c(0.23, 0.48),  # Position legend inside the plot (top-right corner)
    legend.background = element_rect(fill = alpha("white", 0.6))  # Semi-transparent background for readability
  )+
  stat_compare_means(
    data = h_tibble,  # Use raw data for comparisons
    aes(x = Filt, y = Error),  # Specify x and y axes for p-values
    comparisons = list(c("Ref", "GS"), c("Ref", "Comb"), c("Ref", "Unfilt")),  # Define comparisons
    label = "p",  # Show exact p-values
    method = "wilcox.test"  # Wilcoxon test for comparisons
  )


# ggsave("figures/rmse_signif.pdf", plot = g1, width = 6, height = 6, dpi = 300)



```

```{r Box plots and Means compares for RMSE}


g1 <- ggboxplot(plot_rmse,x = "Filt",y = "Error",fill = "MVC_Voli_Cat", palette = "jco", short.panel.labs = FALSE, ylim = c(0, 0.7))+
  facet_wrap(~Effort_Type)+
  labs(
    x = "Filter",
    y = "Normalized Root Mean Squared Error",
    title = "Finger Extension Experiments",
    subtitle = sprintf("%d participants", length(unique(plot_rmse$Test)))) +  
  theme_minimal() +
  stat_compare_means(label = "p.signif",  # Show exact p-values
    method = "wilcox.test",  # Wilcoxon test for comparisons 
    comparisons = list(c("Ref", "GS"), c("Ref", "Comb"), c("Ref", "Unfilt")),
        label.y = c(0.44, 0.52, 0.6)  # Adjust these values to position each comparison
)+
  theme(
    strip.background = element_blank(),
    #strip.text = element_text(face = "bold"),
    legend.position = c(0.15, 0.45),  # Position legend inside the plot (top-right corner)
    legend.background = element_rect(fill = alpha("white", 0.6))  # Semi-transparent background for readability
  )
g1
g2<-  ggboxplot(plot_rmse,x = "Filt",y = "Error",fill = "MVC_Voli_Cat", palette = "jco", short.panel.labs = FALSE, ylim = c(0, 0.5))+
  facet_grid(~Effort_Type+Test)+
  labs(
    x = "Filter",
    y = "Normalized Root Mean Squared Error",
    title = "Finger Extension Experiments",
    subtitle = sprintf("%d participants", length(unique(plot_rmse$Test)))) +  
  theme_minimal() +
  stat_compare_means(label = "p.signif",  # Show exact p-values
    method = "wilcox.test",  # Wilcoxon test for comparisons 
    comparisons = list(c("Ref", "GS"), c("Ref", "Comb"), c("Ref", "Unfilt")),
        label.y = c(0.3, 0.33, 0.38)  # Adjust these values to position each comparison
)+
  theme(
    strip.background = element_blank(),
    #strip.text = element_text(face = "bold"),
    legend.position = c(0.15, 0.35),  # Position legend inside the plot (top-right corner)
    legend.background = element_rect(fill = alpha("white", 0.6))  # Semi-transparent background for readability
  )


g1
g1/g2

# ggsave("figures/rmse_signif.pdf", plot = g1, width = 6, height = 6, dpi = 300)

```

```{r }
library(dplyr)
library(ggplot2)

# Calculate means and 95% confidence intervals
summary_data <- plot_rmse %>%
  group_by(Effort_Type, Filt, MVC_Voli_Cat) %>%
  summarise(
    mean_error = mean(Error, na.rm = TRUE),
    sd_error = sd(Error, na.rm = TRUE),
    n = n(),
    se = sd_error / sqrt(n),
    ci_lower = mean_error - qt(0.975, df = n - 1) * se,
    ci_upper = mean_error + qt(0.975, df = n - 1) * se,
    .groups = "drop"
  )

# Calculate p-values for each participant and effort type
pvals <- plot_rmse %>%
  group_by(Effort_Type) %>%
  summarise(
    p_GS = wilcox.test(Error[Filt == "Ref"], Error[Filt == "GS"])$p.value,
    p_Comb = wilcox.test(Error[Filt == "Ref"], Error[Filt == "Comb"])$p.value,
    p_Unfilt = wilcox.test(Error[Filt == "Ref"], Error[Filt == "Unfilt"])$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    sig_GS = case_when(
      p_GS < 0.001 ~ "***",
      p_GS < 0.01 ~ "**",
      p_GS < 0.05 ~ "*",
      TRUE ~ "ns"
    ),
    sig_Comb = case_when(
      p_Comb < 0.001 ~ "***",
      p_Comb < 0.01 ~ "**",
      p_Comb < 0.05 ~ "*",
      TRUE ~ "ns"
    ),
    sig_Unfilt = case_when(
      p_Unfilt < 0.001 ~ "***",
      p_Unfilt < 0.01 ~ "**",
      p_Unfilt < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  )

# Create annotation data
annotations <- pvals %>%
  pivot_longer(cols = starts_with("sig_"), 
               names_to = "comparison", 
               values_to = "label",
               names_prefix = "sig_") %>%
  mutate(
    x = case_when(
      comparison == "GS" ~ 2,
      comparison == "Comb" ~ 3,
      comparison == "Unfilt" ~ 4
    ),
    y = case_when(
      comparison == "GS" ~ 0.42,
      comparison == "Comb" ~ 0.46,
      comparison == "Unfilt" ~ 0.50
    )
  )

# Create bar plot with error bars
g1 <- ggplot(summary_data, aes(x = Filt, y = mean_error, fill = MVC_Voli_Cat)) +
  geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), 
                position = position_dodge(0.9), 
                width = 0.25) +
  facet_wrap(~Effort_Type, ncol = 4) +
#  scale_fill_jco() +
  labs(
    x = "Filter",
    y = "Normalized Root Mean Squared Error",
    title = "Finger Extension Experiments",
    subtitle = sprintf("%d participants", length(unique(plot_rmse$Test))),
    fill = "MVC_Voli_Cat"
  ) +
  coord_cartesian(ylim = c(0, 0.5)) +
  theme_minimal() +
  geom_text(data = annotations, 
            aes(x = x, y = y, label = label),
            inherit.aes = FALSE,
            size = 4, 
            vjust = -0.5) +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(size = 8),
    legend.position = "top",
    legend.background = element_rect(fill = alpha("white", 0.6))
  )

g1
```

```{r Plotting: maintain section}

plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat!='Amp_Modul')

NumofTest<-length(unique(plot_tibble$Test) )

p1<-ggplot(plot_tibble, aes(x =  MVC_Voli , y = vprime_mvc , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+
    #geom_segment(aes(x = 10, y = 10, xend = 40, yend = 40, color='No Occlusion Level'))+
 #   facet_grid(EffortType~Feat)+
     facet_grid(~Feat)+
    coord_cartesian(ylim=c(-10,80)) + 
    labs(x = "Volitional Effort: E_v (% MVC)",
    y = "Maintained Volitional effort: E_vprime (% MVC)") +
      theme_minimal(base_size = 15) +
  theme(
    strip.background = element_blank(),
    #strip.text = element_text(face = "bold"),
    legend.position="top",
    #legend.position = c(0.2, 0.4),  # Position legend inside the plot (top-right corner)
    legend.background = element_rect(fill = alpha("white", 0.6))  # Semi-transparent background for readability
    )
p1<-tag_facet(p1, size= 6,hjust = -1)
    
p2<-ggplot(plot_tibble, aes(x =  MVC_Voli , y = Occ_mvc , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+
 #   facet_grid(EffortType~Feat)+
     facet_grid(~Feat)+
  coord_cartesian(ylim=c(-20,50)) + 
    labs(x = "Volitional Effort: E_v (% MVC)",
    y = "Maintained Volitional effort: E_vprime (% MVC)"
    ) +
        theme_minimal(base_size = 15) +
  theme(
    strip.background = element_blank(),
    #strip.text = element_text(face = "bold"),
    legend.position="top",
    #legend.position = c(0.2, 0.4),  # Position legend inside the plot (top-right corner)
    legend.background = element_rect(fill = alpha("white", 0.6))  # Semi-transparent background for readability
  )
p2<-tag_facet(p2, size= 6,hjust = -1)

#pdf("finger_occ_lines.pdf", width = 8, height = 10) 
suppressWarnings(print(p1/p2))

#dev.off()

lm_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat=="EffortMea")

#lm_tibble <- lm_tibble %>%
  #mutate(Test = relevel(Test, ref = "jan7"))
m1 <- lm(Occ_mvc ~ MVC_Voli + MVC_Stim , data = lm_tibble)
tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

summary(lm_tibble)

 m2 <- lm(Occ_Dropped_mvc ~ (MVC_Voli + MVC_Stim), data = lm_tibble) 
tidy(m2,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

```

```{r }

plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat!='Amp_Modul')
#plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat!='Amp_Modul',EffortType=="Hand")

tibblelong<-plot_tibble%>%pivot_longer(cols=c('Occ_mvc','Occ_Dropped_mvc','Occ_Hybrid_mvc'),
                                    names_to='Occlusion_Type',
                                    values_to='Occlusion_Val')%>%mutate(Occlusion_Type = as.factor(Occlusion_Type))

tibblelong2<-filter(tibblelong, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat=='EffortMea')

p1<-ggplot(plot_tibble, aes(x =  MVC_Voli , y = Occ_mvc , color =Feat )) +
    geom_point() +
    geom_smooth(method = "lm")+
    facet_wrap(~MVC_Stim_Cat)+
    ylim(-20, 90)+
    labs(x = "Volitional Effort: E_v (% MVC)",
    y = "Occlusion (% MVC)",
    title = "Occluded force and MAV",
    subtitle = sprintf("%d able-body participants",length(unique(plot_tibble$Test) )))

p2<-ggplot(tibblelong2, aes(x =  v_mvc , y = Occlusion_Val , color =Occlusion_Type )) +
    geom_point() +
    geom_smooth(method = "lm")+
    facet_wrap(~MVC_Stim_Cat,scales="free")+
    labs(x = "Volitional Effort: E_v (% MVC)",
    y = "Occlusion (% MVC)",
    title = "Occluded force and MAV",
    subtitle = sprintf("%d able-body participants",length(unique(plot_tibble$Test) )))

p1/p2

```

```{r EMBC2025 figure}

plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat!='Amp_Modul')
#plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat!='Amp_Modul',EffortType=="Hand")

tibblelong<-plot_tibble%>%pivot_longer(cols=c('Occ_mvc','Occ_Dropped_mvc','Occ_Hybrid_mvc'),
                                    names_to='Occlusion_Type',
                                    values_to='Occlusion_Val')%>%mutate(Occlusion_Type = as.factor(Occlusion_Type))

tibblelong2<-filter(tibblelong, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat=='EffortMea',Occlusion_Type!='Occ_Hybrid_mvc')%>%
  mutate(
    Occlusion_Type = as.factor(Occlusion_Type),
    Occlusion_Type = forcats::fct_relevel(Occlusion_Type, "Occ_mvc")
  )

p1<-ggplot(plot_tibble, aes(x =  MVC_Voli , y = Occ_mvc , color = MVC_Stim_Cat  )) +
    geom_point() +
    geom_smooth(method = "lm")+
    facet_wrap(~Feat)+
    coord_cartesian(ylim=c(-20,100)) + 
    labs(x = "Volitional Effort: E_v (% MVC)",
    y = "Occlusion (% MVC)",
    title = "Occluded force and MAV",
    subtitle = sprintf("%d people without stroke",length(unique(plot_tibble$Test) ))) +
  theme_minimal() +
  theme(
    strip.background = element_blank(),
    legend.position = c(0.1, 0.8),
    legend.background = element_rect(fill = alpha("white", 0.6))
  )

p2<-ggplot(tibblelong2, aes(x =  v_mvc , y = Occlusion_Val , color = MVC_Stim_Cat  )) +
    geom_point() +
    geom_smooth(method = "lm")+
    facet_wrap(~Occlusion_Type,scales="free")+
    labs(x = "Volitional Effort: E_v (% MVC)",
    y = "Occlusion (% MVC)",
    title = "Occluded force and MAV",
    subtitle = sprintf("%d able-body participants",length(unique(plot_tibble$Test) ))) +
  theme_minimal() +
  theme(
    strip.background = element_blank(),
    legend.position = c(0.1, 0.2),
    legend.background = element_rect(fill = alpha("white", 0.6))
  )

p1

```

```{r Plotting for EMBC 2024 (updated for 2025) }
library(ggforce)  # If `tag_facet()` is used
library(dplyr)

plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat=='EffortMea')

occ_err_long<-plot_tibble%>%pivot_longer(cols=c('Occ_mvc','vprime_mvc'),
                                    names_to='Occlusion_Type',
                                    values_to='Occlusion_Val')%>%mutate(Occlusion_Type = as.factor(Occlusion_Type))

occ_err_long <- occ_err_long %>%
  mutate(Occlusion_Type = relevel(Occlusion_Type, ref = "vprime_mvc"))

my_labeller <- as_labeller(c(Occ_mvc='Occluded~Effort~(E[o])', vprime_mvc="Maintained~Level~(V^I)"), label_parsed)

p1<-ggplot(occ_err_long, aes(x =  v_mvc , y = Occlusion_Val , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+
    #geom_segment(
  #      data = subset(occ_err_long, Occlusion_Type == "vprime_mvc"),
   #     aes(x = 9, y = 0, xend = 41, yend = 0),
   #     color = "black", linetype = "dashed"
   # )+
  facet_wrap(~Occlusion_Type,scales='free',labeller = my_labeller)+
    #ylim(-20,75)+
    labs(x = expression("Volitional Effort (V)" ),
    y = "% Effort")+
    #title = "",
    #subtitle = "                                (b)                                                                  (c)")+
    scale_color_hue(labels=c('10% Stim.', '20% Stim.', '30% Stim.','Zero Error'),name= expression("Stimulated Effort (S)"))+
    theme(legend.position = c(0.7, 0.16))+
    theme_minimal(base_size = 16) +
  theme(
    strip.background = element_blank(),
    legend.position = c(0.5, 0.2),
    legend.background = element_rect(fill = alpha("white", 0.6))
  )
p1<-tag_facet(p1, size= 6)

#pdf("occ_embc2.pdf", width = 6, height = 4)  # specify dimensions in inches

suppressWarnings(print(p1))

#dev.off()


```

```{r }
simp_tipple<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat=='EffortMea')%>%
  select(Occ_mvc,Occ_Dropped_mvc,MVC_Stim_Cat,MVC_Voli,MVC_Stim,v_mvc,Feat)

simp_tipple$Occ_Dropped_mvc<-simp_tipple$Occ_Dropped_mvc

simp_tipple<-simp_tipple%>%pivot_longer(cols=c('Occ_mvc','Occ_Dropped_mvc'),                                                                                                           names_to='Occ_Type', values_to='MAV')

simp_tipple<-simp_tipple%>%mutate(Occ_Type=recode(Occ_Type,
                                                      'Occ_mvc' = 'Occlusion',
                                                      'Occ_Dropped_mvc' = 'Dropped Frames-Based Occlusion'))

simp_tipple<-filter(simp_tipple, Occ_Type == 'Occlusion')

p1<-ggplot(simp_tipple, aes(x =  MVC_Voli , y = MAV , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+
    #facet_wrap(~Occ_Type)+
    labs(x = "Volitional Effort: E_v (% Effort)",
    y = "Occlusion (% Effort)",
    subtitle = "                                                                         (b)                                       ")+
    scale_color_hue(labels=c('10% Stim', '20% Stim', '30% Stim'),name="Stimulated Effort")+
    theme(legend.position = c(0.1, 0.17))

#pdf("conf1_ver2.pdf") 

suppressWarnings(print(p1/p2))

#dev.off()

 #m1 <- lm(MAV ~ (MVC_Voli + MVC_Stim), data = filter(simp_tipple, Occ_Type=='Force-Based Occlusion')) 
#tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)
 #m2<- lm(MAV ~ (MVC_Voli + MVC_Stim), data = filter(simp_tipple, Occ_Type=='Dropped Frames-Based Occlusion')) 
#tidy(m2,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)
```

```{r Occlusion Heat Map}
plot_tibble<-filter(occ, MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt')

ggplot(plot_tibble, aes(x = MVC_Stim_Cat , y =  MVC_Voli_Cat, fill = Occ_mvc)) +
    geom_tile() +
    geom_smooth(method = "lm")+
    facet_wrap(~Feat)

```

```{r}

plot_tibble<-filter(occ,MVC_Stim_Cat!="Stim_0",Tau=="3*tau",Filt=='Unfilt',Feat=='MAV')

g1<-ggplot(plot_tibble, aes(x =  MVC_Voli, y = Occ_mvc, color = MVC_Stim_Cat))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_wrap(~Test)
g2<-ggplot(plot_tibble, aes(x =  MVC_Voli, y = Occ_Dropped_mvc, color = MVC_Stim_Cat))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_wrap(~Test)
g3<-ggplot(plot_tibble, aes(x =  MVC_Voli, y = Occ_Hybrid_mvc, color = MVC_Stim_Cat))+ 
  geom_point()+
  geom_smooth(method = "lm")+
  facet_wrap(~Test)

g1/g2/g3

filter(plot_tibble,Test=="oct18"  )%>% group_by(MVC_Stim_Cat)%>%summarise(count = n(),v_mvc)%>% arrange(desc(count))
```

```{r }

filt="GS"
type="Occ_mvc"
Log=TRUE
coef_filt<-filter(coef, MVC_Stim_Cat!="Stim_0" &Type==type & Log==Log )

g1<-ggplot(coef_filt, aes(x = MVC_Voli, y = Effort_o-Occ,  color = MVC_Stim_Cat))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_grid(~Test)
g2<-ggplot(coef_filt, aes(x =  MVC_Voli, y = Occ, color = MVC_Stim_Cat))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_grid(~Test)
g3<-ggplot(coef_filt, aes(x =  MVC_Voli, y = Occ, color = MVC_Stim_Cat))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_grid(~Test)

g1/g2/g3

filter(plot_tibble,Test=="oct18"  )%>% group_by(MVC_Stim_Cat)%>%summarise(count = n(),v_mvc)%>% arrange(desc(count))
```

```{r Plotting: dropped frames occlusion}
plotibble<-filter(droppedocc, NumofDropped !='4_Drops', MAV_Type !='OccHybrid', MAV_Type !='Comb',EffortType=="Hand")
formula <- y ~ poly(x, 1, raw = TRUE)
my.format <-"b[0]~`=`~%.3g*\", \"*b[1]~`=`~%.3g"
p1<-ggplot(plotibble, aes(x =  MVC_Voli , y = MAV, color = MAV_Type))+
  geom_point() +
  geom_smooth(method = "lm",level=0.90)+
  #geom_segment(aes(x = 10, y = 10, xend = 40, yend = 40, color='No Occlusion Level'))+
  ylim(-00, 200)+
  facet_wrap(~MVC_Stim_Cat)

suppressWarnings(print(p1))

#lm_tibble<-filter(plotibble, MAV_Type =='Dropped')

  m1 <- lm(100*MAV ~ MVC_Voli+MVC_Stim+MAV_Type, data = plotibble) 
tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

```

```{r Plotting: maintain section}
filt="GS"
occ_type="Occ_mvc"
log_model=FALSE
effort_type="Force"
occ_err<-filter(err, MVC_Stim_Cat!="Stim_0",Filt==filt, Occ_Type==occ_type,EffortType==effort_type, LogModel==log_model)
occ_err1<-filter(err, MVC_Stim_Cat!="Stim_0", Occ_Type==occ_type, EffortType==effort_type, LogModel==log_model)

p1<-ggplot(occ_err, aes(x =  VoliMVC , y = Effort_e_MAV_err-10 , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 10, y = 0, xend = 40, yend = 0, color='Zero Error'))+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error before Occlusion Correction",
    subtitle = sprintf('%s filtered, %d able body participants',filt,length(unique(occ_err$Test))))+
  ylim(-30, 50)

p2<-ggplot(occ_err, aes(x =  VoliMVC , y = Effort_MAV_err-10 , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 10, y = 0, xend = 40, yend = 0, color='Zero Error'))+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error after Occlusion Correction",
    subtitle = sprintf('%s filtered, %d able body participants',filt,length(unique(occ_err$Test))))+
  ylim(-30, 50)

p3<-ggplot(occ_err1, aes(x =  VoliMVC , y = Effort_MAV_err , color = Filt)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 10, y = 0, xend = 40, yend = 0, color='Zero Error'))+
    ylim(-100, 40)
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "",
    subtitle = " Comparing Different Filters")+
      ylim(-30, 50)

p1/p2 -p3


```

```{r Individualized vs Avg occ errors}

filt="GS"
log_model=FALSE
effort_type="Force"
occ_err<-filter(err, MVC_Stim_Cat!="Stim_0", Occ_Type!="Occ_Hybrid_mvc", LogModel==log_model, Filt==filt)

long_tibble<-occ_err%>%pivot_longer(cols=c('Effort_e_MAV','Effort_MAV','Effort_MAV_Indv'),
                                        names_to='Corrected_Efforts', values_to='Effort_Val')%>%
  pivot_longer(cols=c('Effort_e_MAV_err','Effort_MAV_err','Effort_MAV_Indv_err'),
                                        names_to='Corrected_Errors', values_to='Error_Val')

long_tibble<-long_tibble%>%mutate(Error_Names=recode(Corrected_Errors,
                                'Effort_e_MAV_err' = 'Before_Correction',
                                'Effort_MAV_err' = 'Averaged_Correction',
                                'Effort_MAV_Indv_err' = 'Individualized_Correction')) %>%
            mutate(Occlusion_Names=recode(Occ_Type,
                                 'Occ_Dropped_mvc' = 'Dropped_Frames_Based',
                                'Occ_mvc' = 'Effort_Based'))

long_tibble <- long_tibble %>%
  mutate(Error_Names = relevel(factor(Error_Names), ref = "Before_Correction"))

filtered_data <- long_tibble %>%
  filter(EffortType %in% c("Force", "Hand"))
filtered_data <- filtered_data %>%
  filter(!is.na(Error_Val)) 
# Group by variables and calculate mean and standard deviation of Error_Val
summary_data <- filtered_data %>%
  group_by(Test, Error_Names, Occlusion_Names, EffortType) %>%
  summarise(
    avg_error = mean(Error_Val, na.rm = TRUE),
    n = n(), # Count of observations
    se = sd(Error_Val, na.rm = TRUE) / sqrt(n), # Standard error of the mean
    ci_lower = avg_error - qt(0.975, df = n - 1) * se, # 95% CI lower bound
    ci_upper = avg_error + qt(0.975, df = n - 1) * se  # 95% CI upper bound
  )

p1<-ggplot(filter(long_tibble,EffortType==effort_type, Error_Names!='Individualized_Correction'), aes(x =  VoliMVC , y = Error_Val , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    facet_wrap( Error_Names  ~  Occlusion_Names)+
   # ylim(-20, 20)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error BEFORE Occlusion Correction",
    subtitle = sprintf(' %s filtered, Log:%s, %s experiments', filt,log_model, effort_type))+
      theme(legend.position = c(0.8, 0))


p2<-ggplot(long_tibble, aes(x =  Test , y = Error_Val , color = Error_Names)) +
    geom_boxplot(notch = FALSE) +
    facet_grid(  Occlusion_Names ~ . )+
    ylim(-100, 40)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error Before and After Occlusion Correction",
    subtitle = sprintf(' %s filtered, Log:%s', filt,log_model))+
theme(
 legend.position = c(0.5, 0.1),
  legend.direction = "horizontal",
  legend.box = "horizontal" # Ensures all legend items are in a single row
)
p3 <- ggplot(summary_data, aes(x = Test, y = avg_error, fill = Error_Names)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper),
                width = 0.2, position = position_dodge(0.9)) +
  facet_wrap(~Occlusion_Names) +
  labs(
    x = "Test",
    y = "Average Error (Â± CI)",
    title = "Average Errors and 95% Confidence Intervals",
    fill = "Effort Type"
  ) +
     theme(
 legend.position = c(0.5, 0.1),
  legend.direction = "horizontal",
  legend.box = "horizontal" # Ensures all legend items are in a single row
 )

#pdf("occ_tests.pdf", width = 8, height = 10)  # specify dimensions in inches

#p2

#dev.off()

p1/p2

p2

```

```{r }

ggplot(plotibble, aes(x =  VoliMVC , y = MAV*100, color = MAV_Type))+
  geom_point() +
  geom_abline(aes(intercept=13.842, slope=0.373,color='Dropped'))+
  geom_abline(aes(intercept=13.842-8.221, slope=0.373+0.570,color='NoStim'))+
  geom_abline(aes(intercept=13.842-22.053, slope=0.373+0.197,color='Occ'))

```

```{r Individualized vs Avg occ errors}

filt="GS"
type='Occ_mvc'
occ_err<-filter(err,EffortType=="Hand", MVC_Stim_Cat!="Stim_0",Filt==filt, Occ_Type==type)
Log=FALSE
occ_err1<-filter(err, MVC_Stim_Cat!="Stim_0")

p1<-ggplot(filter(occ_err,LogModel==Log), aes(x =  VoliMVC , y = Effort_e_Amp_err , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    ylim(-55, 25)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error BEFORE Occlusion Correction",
    subtitle = sprintf('%s equation with %s filtered results',type, filt))

p2<-ggplot(filter(occ_err,LogModel==Log), aes(x =  VoliMVC , y = Effort_Amp_Indv_err , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    ylim(-55, 25)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error Using INDIVIDUAL Occlusion Correction",
    subtitle = sprintf('%s equation with %s filtered results',type, filt))

p3<-ggplot(filter(occ_err,LogModel==Log), aes(x =  VoliMVC , y = Effort_Amp_err , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    ylim(-55, 25)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error Using AVERAGED Occlusion Correction",
    subtitle = sprintf('%s equation with %s filtered results',type, filt))

mean_err<-occ_err %>% filter(LogModel==Log) %>% group_by(MVC_Voli_Cat) %>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_e_Amp_err),2), "RMS"=round(sqrt(mean(Effort_e_Amp_err^2)),2),"Est"='Before Correction', "Log"=Log) 

mean_err<-mean_err%>%add_row(occ_err %>% filter(LogModel==Log)%>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_Amp_Indv_err),2), "RMS"=round(sqrt(mean(Effort_Amp_Indv_err^2)),2),"Est"='Individualized Correction',"Log"=Log) )

mean_err<-mean_err%>%add_row(occ_err %>% filter(LogModel==Log) %>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_Amp_err),2), "RMS"=round(sqrt(mean(Effort_Amp_err^2)),2),"Est"='After Correction',"Log"=Log) )

Log=TRUE
mean_err<-mean_err%>%add_row(occ_err %>% filter(LogModel==Log)%>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_e_Amp_err),2), "RMS"=round(sqrt(mean(Effort_e_Amp_err^2)),2),"Est"='Before Correction',"Log"=Log) )

mean_err<-mean_err%>%add_row(occ_err %>% filter(LogModel==Log)%>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_Amp_Indv_err),2), "RMS"=round(sqrt(mean(Effort_Amp_Indv_err^2)),2),"Est"='Individualized Correction',"Log"=Log) )

mean_err<-mean_err%>%add_row(occ_err %>% filter(LogModel==Log) %>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_Amp_err),2), "RMS"=round(sqrt(mean(Effort_Amp_err^2)),2),"Est"='After Correction',"Log"=Log) )

p4<-ggplot(mean_err, aes(x =  Est , y = Mean , color = Est)) +
    geom_boxplot(notch = FALSE) +
    #geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    ylim(-20, 20)+
    facet_wrap(~Log)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Mean",
    subtitle = sprintf('%s filtered results',filt))
p5<-ggplot(mean_err, aes(x =  Est , y = RMS , color = Est)) +
    geom_boxplot(notch = FALSE) +
    #geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    facet_wrap(~Log)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "RMS",
    subtitle = sprintf('%s filtered results',filt))


p1/p2/p3-p4/p5
```

```{r }
filt="GS"
type='Occ_Hybrid_mvc'
Log=FALSE
occ_err<-filter(err, MVC_Stim_Cat!="Stim_0",Filt==filt, Occ_Type!=type,LogModel==Log)%>%
  select(Occ_Type,Effort_Amp_err,Effort_e_Amp_err,MVC_Stim_Cat,VoliMVC)
occ_err_wide<-occ_err %>% pivot_wider(names_from = Occ_Type, values_from = Effort_Amp_err)

occ_err_long<-occ_err_wide%>%pivot_longer(cols=c('Occ_mvc','Occ_Dropped_mvc','Effort_e_Amp_err'),
                                    names_to='Occ_Error_Type',
                                    values_to='Error')%>%mutate(Occ_Error_Type=recode(
                                      Occ_Error_Type,'Occ_mvc' = 'Force Based',
                                      'Occ_Dropped_mvc' = 'Dropped Frames\nBased',
                                      'Effort_e_Amp_err' = 'Before Correction'))

occ_err1<-filter(err, MVC_Stim_Cat!="Stim_0",Occ_Type=="Occ_mvc")

p1<-ggplot(occ_err_long, aes(x =  VoliMVC , y = Error , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    facet_wrap(~Occ_Error_Type)+
    ylim(-50, 20)+
    labs(x = "Volitional Effort: E_v (% Effort)",
    y = "Effort Estimation Error (% Effort)",
    subtitle = sprintf('                      (a)                                             (b)                                           (c)',type, filt))+
    scale_color_hue(labels=c('10% Stim', '20% Stim', '30% Stim','Zero Error'),name="Stimulated \nEffort Levels")+
  theme(legend.position = c(0.92, 0.3))


p2<-ggplot(occ_err_long, aes(x =  Occ_Error_Type , y = Error,color=Occ_Error_Type )) +
    geom_boxplot(notch=TRUE)+
    ylim(-55, 25)+
    geom_signif(comparisons = list(c("Before Correction","Dropped Frames\nBased")), 
                y_position = 10, tip_length = 0.02, vjust = 0.1, map_signif_level=TRUE,annotation = c("*"),color = "black") +
    geom_signif(comparisons = list(c("Dropped Frames\nBased","Force Based")),
                y_position = 14, tip_length = 0.02, vjust = 0.1, map_signif_level=TRUE,annotation = c(""),color = "black")+
    geom_signif(comparisons = list(c("Before Correction","Force Based")), 
                y_position = 17, tip_length = 0.02, vjust = 0.1, map_signif_level=TRUE,annotation = c("*"),color = "black") +
    labs(x = "Volitional Effort: E_v (% Effort)",
    y = "Effort Estimation Error (% Effort)",
     subtitle = "                               (d)  ")+
    scale_color_hue(labels=c('Before Correction', 'Dropped Frames\nBased', 'Force Based'),name="Correction")+
    theme(legend.position = c(0.8, 0.2))

p3<-ggplot(occ_err1, aes(x =  Filt , y = Effort_Amp_err , color = Filt)) +
    geom_boxplot(notch=TRUE)+
    #geom_smooth(method = "lm")+ 
   # geom_segment(aes(x = 10, y = 0, xend = 40, yend = 0, color='Zero Error'))+
    ylim(-50, 50)+
    geom_signif(comparisons = list(c("Comb","Unfilt")), 
                y_position = 40, tip_length = 0.02, vjust = 0.1, map_signif_level=TRUE,annotation = c("*"),color = "black") +
    geom_signif(comparisons = list(c("GS","Comb")),
                y_position = 35, tip_length = 0.02, vjust = 0.1, map_signif_level=TRUE,annotation = c("*"),color = "black")+
    geom_signif(comparisons = list(c("Unfilt","GS")), 
                y_position = 30, tip_length = 0.02, vjust = 0.1, map_signif_level=TRUE,annotation = c("*"),color = "black") +
    labs(x = "Volitional Effort: E_v (% Effort)",
    y = "Effort Estimation Error (% Effort)",
    #title = "",
    subtitle = "                               (e)")+
    #scale_color_hue(labels=c('Comb', 'GS', 'Unfiltered'),name="Filter")+
    theme(legend.position = c(0.8, 0.2))


#pdf("occ_cor.pdf") 

suppressWarnings(print(p1/(p2-p3)))

#dev.off()

mean_err_type<-occ_err_long %>% group_by(Occ_Error_Type)  %>% summarise( "Mean"= round(mean(Error),2), "RMS"=round(sqrt(mean(Error^2)),2),"Est"='Before Correction') 

#mean_err<-mean_err%>%add_row(occ_err %>% filter(LogModel==Log)%>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_Amp_Indv_err),2), "RMS"=round(sqrt(mean(Effort_Amp_Indv_err^2)),2),"Est"='Individualized Correction',"Log"=Log) )

#mean_err<-mean_err%>%add_row(occ_err %>% filter(LogModel==Log) %>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_Amp_err),2), "RMS"=round(sqrt(mean(Effort_Amp_err^2)),2),"Est"='After Correction',"Log"=Log) )

```

```{r }
filt="GS"
type='Occ_Hybrid_mvc'
Log=FALSE
occ_err<-filter(err, EffortType=="Force", MVC_Stim_Cat!="Stim_0",Filt==filt, Occ_Type!=type,LogModel==Log)%>%
  select(Occ_Type,Effort_Amp_err,Effort_e_Amp_err,MVC_Stim_Cat,VoliMVC,Test)

occ_err_wide<-occ_err %>% pivot_wider(names_from = Occ_Type, values_from = Effort_Amp_err)

occ_err_long<-occ_err_wide%>%pivot_longer(cols=c('Occ_mvc','Occ_Dropped_mvc','Effort_e_Amp_err'),
                                    names_to='Occ_Error_Type',
                                    values_to='Error')%>%mutate(Occ_Error_Type = as.factor(Occ_Error_Type))

#%>%mutate(Occ_Error_Type=recode(
 #                                     Occ_Error_Type,'Effort_e_Amp_err' = 'Uncorrected',
  #                                    'Occ_mvc' = 'Occlusion Corrected',
   #                                   'Occ_Dropped_mvc' = 'Dropped Frames\nBased'
    #                                  ))

occ_err1<-filter(err, MVC_Stim_Cat!="Stim_0", Occ_Type=="Occ_mvc")

summary(occ_err1)

occ_err_long <- occ_err_long %>%
  mutate(Occ_Error_Type = relevel(Occ_Error_Type, ref = "Effort_e_Amp_err"))

my_labeller <- as_labeller(c(Occ_mvc="E[o]+E[e]", Effort_e_Amp_err="E[e]", Occ_Dropped_mvc="E[d]+E[e]"),
                          default = label_parsed)

#occ_err_long<-filter(occ_err_long, Occ_Error_Type!="Occ_Dropped_mvc")

p1<-ggplot(occ_err_long, aes(x =  VoliMVC , y = Error , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    facet_wrap(~Occ_Error_Type,labeller=my_labeller)+
    ylim(-50, 20)+
    labs(x = expression("Volitional Effort (E"[v]*") "),
    y = "Effort Estimation Error (% Effort)",
    subtitle = sprintf('                                 (a)                                                                  (b)                           ',type, filt))+
    scale_color_hue(labels=c('10% Stim', '20% Stim', '30% Stim','Zero Error'),name=expression("Stim. Effort (E"[s]*")"))+
  theme(legend.position = c(0.6, 0.3))


p2<-ggplot(occ_err_long, aes(x =  Occ_Error_Type , y = Error,color=Occ_Error_Type )) +
    geom_boxplot(notch=TRUE)+
  geom_jitter(width = 0.2, alpha = 0.5) +  # Add scatter points with jitter
    ylim(-55, 25)+
    geom_signif(comparisons = list(c("Occ_mvc","Effort_e_Amp_err")), 
                y_position = 15, tip_length = 0.02, vjust = 0.1, map_signif_level=TRUE,annotation = c("*"),color = "black") +

    labs(x = "Volitional Effort: E_v (% Effort)",
    y = "Effort Estimation Error (% Effort)",
     subtitle = "                                 (c)  ")+
    scale_color_hue(labels=c('Uncorrected', 'Dropped Frames', 'Force Based'),name="Correction Methods")+
    theme(legend.position = c(0.7, 0.2))


p3<-ggplot(occ_err1, aes(x =  Filt , y = Effort_Amp_err , color = Filt)) +
    geom_boxplot(notch=TRUE)+
    geom_jitter(width = 0.2, alpha = 0.5) +  # Add scatter points with jitter
    #geom_smooth(method = "lm")+ 
   # geom_segment(aes(x = 10, y = 0, xend = 40, yend = 0, color='Zero Error'))+
    ylim(-50, 50)+
    geom_signif(comparisons = list(c("Comb","Unfilt")), 
                y_position = 40, tip_length = 0.02, vjust = 0.1, map_signif_level=TRUE,annotation = c("*"),color = "black") +
    geom_signif(comparisons = list(c("GS","Comb")),
                y_position = 35, tip_length = 0.02, vjust = 0.1, map_signif_level=TRUE,annotation = c("*"),color = "black")+
    geom_signif(comparisons = list(c("Unfilt","GS")), 
                y_position = 30, tip_length = 0.02, vjust = 0.1, map_signif_level=TRUE,annotation = c("*"),color = "black") +
    labs(x = "Volitional Effort: E_v (% Effort)",
    y = "Effort Estimation Error (% Effort)",
    #title = "",
    subtitle = "                              (d)")+
    scale_color_hue(labels=c('Comb', 'GS', 'Unfiltered'),name="Filter")+
    theme(legend.position = c(0.8, 0.2))

pdf("non_isometric.pdf") 

suppressWarnings(print(p1/(p2-p3)))

dev.off()

anova(lm(Error ~ Occ_Error_Type, data =  occ_err_long))
TukeyHSD(aov(Error ~ Occ_Error_Type, data = occ_err_long))

anova(lm(Effort_Amp_err ~ Filt, data =  occ_err1))
TukeyHSD(aov(Effort_Amp_err ~ Filt, data = occ_err1))
mean_err_type<-occ_err_long %>% group_by(Occ_Error_Type)  %>% summarise( "Mean"= round(mean(Error),2), "RMS"=round(sqrt(mean(Error^2)),2),"Est"='Before Correction') 

#mean_err<-mean_err%>%add_row(occ_err %>% filter(LogModel==Log)%>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_Amp_Indv_err),2), "RMS"=round(sqrt(mean(Effort_Amp_Indv_err^2)),2),"Est"='Individualized Correction',"Log"=Log) )

#mean_err<-mean_err%>%add_row(occ_err %>% filter(LogModel==Log) %>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_Amp_err),2), "RMS"=round(sqrt(mean(Effort_Amp_err^2)),2),"Est"='After Correction',"Log"=Log) )

mean_err_type <- occ_err_long %>%
  group_by(Occ_Error_Type) %>%
  summarise(
    "Mean" = round(mean(Error), 2),
    "RMS" = round(sqrt(mean(Error^2)), 2),
    "Std" = round(sd(Error), 2),  # Standard deviation
    "Est" = 'Before Correction'
  )

# Step 2: Add rows for individualized correction
mean_err <- mean_err %>%
  add_row(
    occ_err %>%
      group_by(MVC_Voli_Cat) %>%
      summarise(
        "Mean" = round(mean(Effort_Amp_Indv_err), 2),
        "RMS" = round(sqrt(mean(Effort_Amp_Indv_err^2)), 2),
        "Std" = round(sd(Effort_Amp_Indv_err), 2),  # Standard deviation
        "Est" = 'Individualized Correction',
        "Log" = Log
      )
  )

# Step 3: Add rows for after correction
mean_err <- mean_err %>%
  add_row(
    occ_err %>%
      filter(LogModel == Log) %>%
      group_by(MVC_Voli_Cat) %>%
      summarise(
        "Mean" = round(mean(Effort_Amp_err), 2),
        "RMS" = round(sqrt(mean(Effort_Amp_err^2)), 2),
        "Std" = round(sd(Effort_Amp_err), 2),  # Standard deviation
        "Est" = 'After Correction',
        "Log" = Log
      )
  )

```

```{r Indiv errors of Tests}
filt="GS"
type="Occ_Dropped_mvc"
occ_err1<-filter(err, MVC_Stim_Cat!="Stim_0" & Filt==filt &  Occ_Type==type)
Log=FALSE

p1<-ggplot(filter(occ_err1,LogModel==Log), aes(x =  VoliMVC , y = Effort_Amp_Indv_err , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    facet_wrap(~Test)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error BEFORE Occlusion Correction",
    subtitle = sprintf('%s equation with %s filtered results',type, filt))
Log=FALSE

p2<-ggplot(filter(occ_err, MVC_Stim_Cat!="Stim_0" & Filt==filt &LogModel==Log), aes(x =  VoliMVC , y = Effort_Amp_Indv_err , color = Occ_Type)) +
    geom_boxplot() +
    #geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    facet_wrap(~Test)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error BEFORE Occlusion Correction",
    subtitle = sprintf('%s filtered results', filt))
p1/p2

filter(occ_err1,Test=="oct25" & LogModel==Log)%>% group_by(MVC_Stim_Cat,Test)%>%summarise(count = n(), Effort_Amp_Indv_err)
```

```{r occ errors of different methods }
filt="GS"
occ_err<-filter(err, MVC_Stim_Cat!="Stim_0",Filt==filt)

p1<-ggplot(occ_err, aes(x =  VoliMVC)) +
  geom_point(aes( y = 10*Effort_e_MAV_err/VoliMVC, color='Before Correction')) +
  geom_point(aes( y = 10*Effort_MAV_err/VoliMVC, color='After Correction')) +
  geom_point(aes( y = 10*Effort_MAV_Indv_err/VoliMVC, color='Indiv. Correction')) +
  geom_smooth(aes(y = 10*Effort_e_MAV_err/VoliMVC, color='Before Correction'), method = "lm") +
  geom_smooth(aes(y = 10*Effort_MAV_err/VoliMVC, color='After Correction'), method = "lm")+
  geom_smooth(aes( y = 10*Effort_MAV_Indv_err/VoliMVC, color='Indiv. Correction'), method = "lm")+
  geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
  facet_wrap(LogModel~Occ_Type)
p1

```

```{r }

occ_err%>% mutate(Diff=decode('Occ_type',filter(occ_err,Occ_Type=='Occ_mvc')-filter(occ_err, Occ_Type=='Occ_dropped_mvc')))
p2<-ggplot(occ_err, aes(x =  VoliMVC)) +
  geom_point(aes( y = 10*Effort_e_MAV_err/VoliMVC, color='Before Correction')) +
  geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))
  #facet_wrap(LogModel~)
```

```{r occ errors of different methods }
filt="GS"
occ_err<-filter(err, MVC_Stim_Cat!="Stim_0",Occ_Type=="Occ_mvc",Filt==filt, LogModel==TRUE)


p1<-ggplot(occ_err, aes(y = Effort_e_Amp, x =  VoliMVC,color=MVC_Stim_Cat)) +
  geom_point()+
  geom_smooth(method = "lm")
#facet_wrap(~MVC_Stim_Cat)

p2<-ggplot(occ_err, aes(y = Effort_e_Amp_err, x =  VoliMVC,color=MVC_Stim_Cat)) +
  geom_point()+
  geom_smooth(method = "lm")
  #facet_wrap(~Test)
p1/p2
```

```{r faceted by Test}

mean_err<-occ_err %>% group_by(Test) %>% summarise( "Mean"= round(mean(Effort_e_Amp_err),2), "RMS"=round(sqrt(mean(Effort_e_Amp_err^2)),2),"Est"='Before Correction') 
mean_err<-mean_err%>%add_row(occ_err %>% group_by(Test) %>% summarise( "Mean"= round(mean(Effort_Amp_Indv_err),2), "RMS"=round(sqrt(mean(Effort_Amp_Indv_err^2)),2),"Est"='Individualized Correction') )
mean_err<-mean_err%>%add_row(occ_err %>% group_by(Test) %>% summarise( "Mean"= round(mean(Effort_Amp_err),2), "RMS"=round(sqrt(mean(Effort_Amp_err^2)),2),"Est"='After Correction') )

ggplot(mean_err, aes(x =  Est , y = Mean , color = Est)) +
    geom_bar(stat = "identity", position=position_dodge()) +
    #geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    facet_wrap(~Test)+
    ylim(-40, 20)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Mean",
    subtitle = sprintf('%s filtered results',filt))

```

```{r linear models}
occ_err_lm<-filter(err, MVC_Stim_Cat!="Stim_0",Filt!="Unfilt" , LogModel==FALSE)
occ_err_lm <- occ_err_lm %>%
  mutate(Filt = relevel(Filt, ref = "GS"))

  m1 <- lm(Effort_Amp_err ~ Filt, data = occ_err_lm) 
tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

occ_err_lm <- occ_err_lm %>%
  mutate(MVC_Stim_Cat = relevel(MVC_Stim_Cat, ref = "Stim_20"))

  m2 <- lm(Effort_Amp_err ~ MVC_Voli+MVC_Stim_Cat, data = filter(occ_err_lm, MVC_Stim_Cat!="Stim_0",Filt=="GS")) 
tidy(m2,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

```

```{r linear models}
occ_err_lm<-filter(err, MVC_Stim_Cat!="Stim_0",Filt!="Unfilt" , LogModel==TRUE)
occ_err_lm <- occ_err_lm %>%
  mutate(Filt = relevel(Filt, ref = "Comb"))

  m1 <- lm(Effort_Amp_err ~ Filt, data = occ_err_lm) 
tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

  m2 <- lm(Effort_Amp_err ~ MVC_Voli_Cat, data = filter(err, MVC_Stim_Cat!="Stim_0",Filt=="GS" )) 
tidy(m2,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

```

The average error for GS is -1.5 while Comb filter estimates an average of -1.5+7.6=6.1. a0 and a1 values are -1.5 and 7.6.

Effort estimation error with comb filter is higher with and average of 6.4 compared to GS filter.

```{r Dropped Frames vs Voli only }

ggplot(droppedocc, aes(x =  VoliMVC , y = MAV*100 , color = MAV_Type)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    facet_wrap(~Test)+
    labs(x = "Volitional Effort Levels : F_v (% MVC)",
    y = "Effort (% MVC)",
    title = "Comparing the Dropped Frames to the Volitional Trials",
    subtitle = sprintf(''))

droppedocc_lm <- filter(droppedocc, MAV_Type == "Occ")
#droppedocc_lm <- droppedocc_lm %>% mutate(MAV_Type = relevel(MAV_Type, ref = "Dropped"))

m1 <- lm(MAV ~ VoliMVC + StimMVC, data = droppedocc_lm) 
tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

```

```{r Dropeed frames error }

dropped_err<-filter(droppedocc, NumofDropped =='1_Drops')

p3<-ggplot(dropped_err, aes(x =  VoliMVC , y = Occ_MAV, color = StimMVC))+
  geom_point() +
  geom_smooth(method = "lm",level=0.90) +
  labs(x = "Volitional MVC",
       y = "Occluded Effort (% MVC)",
       title = "Occluded effort from the dropped frames",
       subtitle = "MAV_dropped-MAV_nostim")
#  geom_segment(aes(x = 10, y = 10, xend = 40, yend = 40, color='No Occlusion Level'))+
#      facet_wrap(~Test)
p3
```

```{r linear models }
#dropped_err <- dropped_err %>%
#  mutate(Filt = relevel(Filt, ref = "Comb"))

  m4 <- lm(Occ_MAV ~ MVC_Voli_Cat, data = dropped_err) 
tidy(m4,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

```

```{r  averaging the occlusion }

mn<-aggregate(cbind(F_occ,F_occ_mvc,F_vprime,F_vprime_mvc) ~ Test + MVC_Stim + MVC_Voli , data = filter(occ,Tau==selected_tau), FUN = mean, na.rm = TRUE)

sdt<-aggregate(cbind(F_occ,F_occ_mvc,F_vprime,F_vprime_mvc) ~ Test + MVC_Stim + MVC_Voli, data = filter(occ,Tau==selected_tau), FUN = sd, na.rm = TRUE)


occ_mean <- aggregate(data=occ, cbind(F_occ,F_occ_mvc), by = list(Test = occ$Test, 
                                             MVC_Stim = occ$MVC_Stim, 
                                             MVC_Voli = occ$MVC_Voli, 
                                             Tau = occ$Tau), mean)
occ_mean <- occ_mean %>% rename(F_occ_mean = x)

occ_sd <- aggregate(occ$F_occ, by = list(Test = occ$Test, 
                                             MVC_Stim = occ$MVC_Stim, 
                                             MVC_Voli = occ$MVC_Voli, 
                                             Tau = occ$Tau), sd)
occ_mean$f_occ_sd<-occ_sd$x

occ_mean_mvc <- aggregate(occ$F_occ_mvc, by = list(Test = occ$Test, 
                                             MVC_Stim = occ$MVC_Stim, 
                                             MVC_Voli = occ$MVC_Voli, 
                                             Tau = occ$Tau), mean)

occ_mean_mvc <- occ_mean_mvc %>% rename(F_occ_mvc_mean = x)

occ_sd_mvc <- aggregate(occ$F_occ_mvc, by = list(Test = occ$Test, 
                                             MVC_Stim = occ$MVC_Stim, 
                                             MVC_Voli = occ$MVC_Voli, 
                                             Tau = occ$Tau), sd)

occ_mean_mvc$F_occ_mvc_sd<-occ_sd_mvc$x

occ_mean$F_occ_mvc_mean<-occ_mean_mvc$F_occ_mvc_mean
occ_mean$F_occ_mvc_sd<-occ_mean_mvc$F_occ_mvc_sd

mean_occ_tbl <- occ_mean %>% group_by( MVC_Voli, MVC_Stim) %>% summarise(mean_occ_mvc=round(mean(F_occ_mvc_mean),2), Std=round(sd(F_occ_mvc_mean),2), mean_F_vprime_mvc=round(mean(F_occ_mvc_mean),2), Std=round(sd(F_occ_mvc_mean),2), n = n())

mean_occ_tbl

```

```{r }
df%>% mutate(bmi_cat = fct_reorder(bmi_cat, triceps_skinfold,.fun = median)) 

df %>% group_by(Test) %>% summarise("Pearson r" = round(cor(TimeConst, MVC_Percent, use="complete"),2), "Spearman r" = round(cor(TimeConst, MVC_Percent, method="spearman",use="complete"),2), "Mean"= round(mean(TimeConst),2))

```

```{r }
plot<-filter(dt)%>% select( c(Frame_Val,Norm_Val, Target, Filt_Type, Dropped,Frame,Test,MVC_Voli,MVC_Stim) )  

mosaic::favstats( Norm_Val~ Filt_Type, MVC_Voli, data = plot)%>% knitr::kable(digits = 2)

ggplot(data = plot, aes(x = Dropped , y = Norm_Val, color = Filt_Type)) + 
geom_boxplot() +
  scale_fill_viridis_d() +
  facet_wrap(Test~ MVC_Voli )+
labs(title = "Normalized EMG MAV Values", y = "Norm. MAV")
   
```
