---
title: "Occlusion Est Error"
output: html_document
date: "2023-09-06"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r including libraries, display=FALSE}
library(magrittr); 
library(here); 
library(janitor)
library(readxl);
library(tidyverse)
library(rmdformats)
library(Epi)
library(vcd)
library(broom)
library(patchwork)
library(vcd)
library(dplyr)
library(ggplot2)
```



```{r Data Inject } 

err_raw<- read_csv("occ_est_error.csv",show_col_types = FALSE)
err_raw

droppedocc<- read_csv("dropped_occ.csv",show_col_types = FALSE)
droppedocc

```



```{r dataframe modifications}


err<-err_raw%>%mutate(MVC_Voli_Cat=recode(VoliMVC,
                                '10' = 'Voli_10',
                                '20' = 'Voli_20',
                                '30' = 'Voli_30',
                                '40' = 'Voli_40')) %>%
            mutate(MVC_Stim_Cat=recode(StimMVC,
                                 '0' = 'Stim_0',
                                '10' = 'Stim_10',
                                '20' = 'Stim_20',
                                '30' = 'Stim_30'))

err<-err%>%mutate(Test = as.factor(Test),
                     Filt = as.factor(Filt),
                     Occ_Type = as.factor(Occ_Type),
                     MVC_Stim_Cat = as.factor(MVC_Stim_Cat),
                     MVC_Voli_Cat = as.factor(MVC_Voli_Cat),
                     MVC_Stim = as.integer(StimMVC),
                      MVC_Voli = as.integer(VoliMVC))

err_raw<-err%>%filter(Test!="mar7",Test!="mar16",Test!="feb27",Test!="apr20")
summary(err)




droppedocc<-droppedocc%>%mutate(MVC_Voli_Cat=recode(VoliMVC,
                                '10' = 'Voli_10',
                                '20' = 'Voli_20',
                                '30' = 'Voli_30',
                                '40' = 'Voli_40')) %>%
            mutate(MVC_Stim_Cat=recode(StimMVC,
                                 '0' = 'Stim_0',
                                '10' = 'Stim_10',
                                '20' = 'Stim_20',
                                '30' = 'Stim_30'))


droppedocc<-droppedocc%>%mutate(Test = as.factor(Test),
                     StimMVC = as.integer(StimMVC),
                     VoliMVC = as.integer(VoliMVC),
                     MVC_Voli_Cat = as.factor(MVC_Voli_Cat),
                     MVC_Stim_Cat = as.factor(MVC_Stim_Cat),
                     Repeat = as.factor(Repeat),
                     NumofDropped = as.factor(NumofDropped))
droppedocc<-droppedocc%>%filter(Test!="mar7",Test!="mar16",Test!="feb27",Test!="apr20")


```


```{r Plotting: maintain section  }
filt="GS"
occ_err<-filter(err, MVC_Stim_Cat!="Stim_0",Filt==filt, Occ_Type=='Occ_mvc')

occ_err1<-filter(err, MVC_Stim_Cat!="Stim_0")

p1<-ggplot(occ_err, aes(x =  VoliMVC , y = Effort_e_Amp_err , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 10, y = 0, xend = 40, yend = 0, color='Zero Error'))+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error before Occlusion Correction",
    subtitle = sprintf('%s filtered results',filt))

p2<-ggplot(occ_err, aes(x =  VoliMVC , y = Effort_Amp_err , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 10, y = 0, xend = 40, yend = 0, color='Zero Error'))+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error after Occlusion Correction",
    subtitle = sprintf(' %s filtered results',filt))

p3<-ggplot(occ_err1, aes(x =  VoliMVC , y = Effort_Amp_err , color = Filt)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 10, y = 0, xend = 40, yend = 0, color='Zero Error'))+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "",
    subtitle = " Comparing Different Filters")
p1/p2 -p3


```
```{r Individualized occ errors}
filt="GS"
occ_err<-filter(err, MVC_Stim_Cat!="Stim_0",Filt==filt, Occ_Type=='Occ_mvc')

occ_err1<-filter(err, MVC_Stim_Cat!="Stim_0")

p1<-ggplot(occ_err, aes(x =  VoliMVC , y = Effort_e_Amp_err , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    ylim(-55, 25)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error before Occlusion Correction",
    subtitle = sprintf('%s filtered results',filt))

p2<-ggplot(occ_err, aes(x =  VoliMVC , y = Effort_Amp_Indv_err , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    ylim(-55, 25)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error Using Individual Occlusion Correction",
    subtitle = sprintf(' %s filtered results',filt))

p3<-ggplot(occ_err, aes(x =  VoliMVC , y = Effort_Amp_err , color = MVC_Stim_Cat)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    ylim(-55, 25)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Effort Estimation Error Using Averaged Occlusion Correction",
    subtitle = sprintf('%s filtered results',filt))
mean_err<-occ_err %>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_e_Amp_err),2), "RMS"=round(sqrt(mean(Effort_e_Amp_err^2)),2),"Est"='Before Correction') 
mean_err<-mean_err%>%add_row(occ_err %>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_Amp_Indv_err),2), "RMS"=round(sqrt(mean(Effort_Amp_Indv_err^2)),2),"Est"='Individualized Correction') )
mean_err<-mean_err%>%add_row(occ_err %>% group_by(MVC_Voli_Cat) %>% summarise( "Mean"= round(mean(Effort_Amp_err),2), "RMS"=round(sqrt(mean(Effort_Amp_err^2)),2),"Est"='After Correction') )

p4<-ggplot(mean_err, aes(x =  Est , y = Mean , color = Est)) +
    geom_boxplot(notch = FALSE) +
    #geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    ylim(-20, 20)+
    facet_wrap( ~ MVC_Voli_Cat)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Mean",
    subtitle = sprintf('%s filtered results',filt))
p5<-ggplot(mean_err, aes(x =  Est , y = RMS , color = Est)) +
    geom_boxplot(notch = FALSE) +
    #geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    facet_wrap( ~ MVC_Voli_Cat)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "RMS",
    subtitle = sprintf('%s filtered results',filt))
p1/p2/p3-p4/p5
```

```{r occ errors of different methods }
filt="GS"
occ_err<-filter(err, MVC_Stim_Cat!="Stim_0",Filt==filt)

ggplot(occ_err, aes(x =  VoliMVC)) +
  geom_point(aes( y = Effort_e_Amp_err, color='Before Correction')) +
  geom_point(aes( y = Effort_Amp_err, color='After Correction')) +
  geom_point(aes( y = Effort_Amp_Indv_err, color='Indiv. Correction')) +
  geom_smooth(aes(y = Effort_e_Amp_err, color='Before Correction'), method = "lm") +
  geom_smooth(aes(y = Effort_Amp_err, color='After Correction'), method = "lm")+
  geom_smooth(aes( y = Effort_Amp_Indv_err, color='Indiv. Correction'), method = "lm")+
  geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
  facet_wrap(~Occ_Type)
```

```{r occ errors of different methods }
filt="GS"
occ_err<-filter(err, MVC_Stim_Cat!="Stim_0",Occ_Type=="Occ_mvc",Filt==filt)


p1<-ggplot(occ_err, aes(y = Effort_e_Amp, x =  VoliMVC,color=MVC_Stim_Cat)) +
  geom_point()+
  geom_smooth(method = "lm")
#facet_wrap(~MVC_Stim_Cat)

p2<-ggplot(occ_err, aes(y = Effort_e_Amp_err, x =  VoliMVC,color=MVC_Stim_Cat)) +
  geom_point()+
  geom_smooth(method = "lm")
  #facet_wrap(~Test)
p1/p2
```


```{r faceted by Test}

mean_err<-occ_err %>% group_by(Test) %>% summarise( "Mean"= round(mean(Effort_e_Amp_err),2), "RMS"=round(sqrt(mean(Effort_e_Amp_err^2)),2),"Est"='Before Correction') 
mean_err<-mean_err%>%add_row(occ_err %>% group_by(Test) %>% summarise( "Mean"= round(mean(Effort_Amp_Indv_err),2), "RMS"=round(sqrt(mean(Effort_Amp_Indv_err^2)),2),"Est"='Individualized Correction') )
mean_err<-mean_err%>%add_row(occ_err %>% group_by(Test) %>% summarise( "Mean"= round(mean(Effort_Amp_err),2), "RMS"=round(sqrt(mean(Effort_Amp_err^2)),2),"Est"='After Correction') )

ggplot(mean_err, aes(x =  Est , y = Mean , color = Est)) +
    geom_bar(stat = "identity", position=position_dodge()) +
    #geom_segment(aes(x = 9, y = 0, xend = 41, yend = 0, color='Zero Error'))+
    facet_wrap(~Test)+
    ylim(-40, 20)+
    labs(x = "Volitional Effort: F_v (% MVC)",
    y = "Effort Estimation Error (% MVC)",
    title = "Mean",
    subtitle = sprintf('%s filtered results',filt))

```


```{r linear models}
occ_err_lm<-filter(err, MVC_Stim_Cat!="Stim_0",Filt!="Unfilt" )
occ_err_lm <- occ_err_lm %>%
  mutate(Filt = relevel(Filt, ref = "Comb"))

  m1 <- lm(Effort_Amp_err ~ Filt, data = occ_err_lm) 
tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

  m2 <- lm(Effort_Amp_err ~ MVC_Voli_Cat, data = filter(err, MVC_Stim_Cat!="Stim_0",Filt=="GS" )) 
tidy(m2,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

```

The average error for GS is -1.5 while Comb filter estimates an average of -1.5+7.6=6.1. a0 and a1 values are -1.5 and 7.6.

Effort estimation error with comb filter is higher with and average of 6.4 compared to GS filter.

```{r Dropped Frames vs Voli only }

ggplot(droppedocc, aes(x =  VoliMVC , y = MAV*100 , color = MAV_Type)) +
    geom_point() +
    geom_smooth(method = "lm")+ 
    facet_wrap(~Test)+
    labs(x = "Volitional Effort Levels : F_v (% MVC)",
    y = "Effort (% MVC)",
    title = "Comparing the Dropped Frames to the Volitional Trials",
    subtitle = sprintf(''))

droppedocc_lm <- filter(droppedocc, MAV_Type == "Occ")
#droppedocc_lm <- droppedocc_lm %>% mutate(MAV_Type = relevel(MAV_Type, ref = "Dropped"))

m1 <- lm(MAV ~ VoliMVC + StimMVC, data = droppedocc_lm) 
tidy(m1,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

```


```{r Dropeed frames error }

dropped_err<-filter(droppedocc, NumofDropped =='1_Drops')

p3<-ggplot(dropped_err, aes(x =  VoliMVC , y = Occ_MAV, color = StimMVC))+
  geom_point() +
  geom_smooth(method = "lm",level=0.90) +
  labs(x = "Volitional MVC",
       y = "Occluded Effort (% MVC)",
       title = "Occluded effort from the dropped frames",
       subtitle = "MAV_dropped-MAV_nostim")
#  geom_segment(aes(x = 10, y = 10, xend = 40, yend = 40, color='No Occlusion Level'))+
#      facet_wrap(~Test)
p3
```


```{r linear models }
#dropped_err <- dropped_err %>%
#  mutate(Filt = relevel(Filt, ref = "Comb"))

  m4 <- lm(Occ_MAV ~ MVC_Voli_Cat, data = dropped_err) 
tidy(m4,conf.int = TRUE ,conf.level =0.95) %>% knitr::kable(digits = 3)

```



